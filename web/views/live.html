<link rel="stylesheet" href="/static/3party/spectrum.css">
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h1" style="padding-top:12px">Live</h1>
</div>
<div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar with button groups">
    <form method="get" action="/liveaction/togglemute" id="togglemute"></form>
    $@form_scene$
        <form method="get" action="/scenes/play" class="scene-form" id="sc_$name$"></form>
    $@@$
    <div class="btn-group mr-2" role="group" aria-label="First group">
        <button type="button" class="btn btn-secondary" id="toggle-drag-and-drop"><i class="fa fa-arrows-alt"></i></button>
        <button type="submit" form="togglemute" class="btn btn-$mute_status$" id="toggle-mute"><i class="fa fa-$mute_icon$"></i></button>
        $@scene$
            <input type="hidden" name="fromlive" value="1" form="sc_$name$">
            <input type="hidden" value="$name$" name="name" form="sc_$name$">
            <button form="sc_$name$" type="button" class="btn btn-secondary scene-play" data-toggle="tooltip" data-placement="bottom" title="$name$"><i class="fa fa-play"></i></button>
        $@@$
    </div>
    <form method="get" action="/liveaction/setmaster">
        <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text" id="btnGroupAddon">Master</div>
                </div>
                <input id="master" name="value" type="range" value="$master$" class="form-control custom-range" placeholder="Master value" aria-label="Input group example" aria-describedby="btnGroupAddon">
        </div>
    </form>
</div>
<div id="live-devices" class="d-flex" style="height: 100%">
$@devices$
    <div data-prio="$priority$" class="border border-primary rounded align-items-center device" style="min-width: 5vw !important;padding:0 15px;flex-shrink: 0;flex-grow: 1">
        <h3>$name$</h3>
        $@color$
        <div>
            <input type='text' class="color-select" value="rgb $red$ $green$ $blue$" data-device="$device$">
        </div>
        $@@$
        <div>
        $@control$
            <form method="get" action="/liveaction/setvalue" class="valueform">
                <input type="range" class="custom-range valuerange $device$-$channel$" max="255" value="$value$" name="value">
                <input value="$channel$" name="channel" type="hidden">
                <input value="$device$" name="device" type="hidden">
                <span class="text-$save$">$channel$</span>
            </form>
        $@@$
        </div>
    </div>
$@@$
</div>
<script src="/static/3party/spectrum.js"></script>
<script src="/static/3party/sortable.js"></script>
<script src="/static/3party/cookies.js"></script>
<script>

function send(message) {
    if (!window.WebSocket) { return; }
    if (socket.readyState == WebSocket.OPEN) {
        socket.send(message);
    } else {
        alert("WebSocket is closed");
    }
}
devices = $(".device");
devices.sort(function (a, b) {
      var contentA =parseInt( $(a).attr('data-prio'));
      var contentB =parseInt( $(b).attr('data-prio'));
    return contentA - contentB;
});
$("#live-devices").html(devices);

var host = "$host$";

$(function () {
  $('[data-toggle="tooltip"]').tooltip();
})
$("#master").on('input', function() {
    $.ajax({
        url : this.form.action,
        type: this.form.method,
        data: $(this.form).serialize()
    }).fail(function() {
        alertify.error("Failed to set master");
    });;
});
$(".scene-form").each(function(){
    $(this).on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url : this.action,
            type: this.method,
            data: $(this).serialize()
        }).fail(function() {
            alertify.error("Failed to play scene");
        });
    });
});
var timeout = false;
$('.valuerange').each(function(){
    $(this).on('input', function() {
        if ($("#master").val() < 3) {
            if (!timeout) {
                alertify.warning("Master is off");
                timeout = true;
                setTimeout(function() {
                    timeout = false;
                }, 800);
            }
        }
        send($(this.form).serialize());
    });
});
$('.color-select').each(function(){
    var device = $(this).attr("data-device");
    $(this).spectrum({
        flat: true,
        showInput: true,
        cancelText: "",
        chooseText: "",
        move: function(color) {
            //console.log(color.toRgb());
            var get = "device=" + device + "&r=" + color.toRgb().r + "&g=" + color.toRgb().g + "&b=" + color.toRgb().b;
            $.ajax({
                url : "/liveaction/setrgb",
                type: "get",
                data: get
            });
        }
    });
});
var sortable = new Sortable(document.getElementById('live-devices'), {
	animation: 150,
	ghostClass: 'blue-background-class',
	onUpdate: function (/**Event*/evt, /**Event*/originalEvent) {
	    var devices = new Map();
	    var i = 0;
	    $('.device').each(function(){
	        devices.set($(this).find("h3").text(), i);
	        i = i + 1;
        });
        //console.log(devices);
        var first = 1;
        var request = "";
        devices.forEach(function(value, key, map){
            if (first == 0) {
                request += "&";
            }
            request += key + "=" + value;
            first = 0;
        });
        console.log(request);
        $.ajax({
            url : "/liveaction/updatePrio",
            type: "get",
            data: request
        }).fail(function() {
            alertify.error("Failed to update prio");
        });;
	}
});
function is_touch_device() {
  var prefixes = ' -webkit- -moz- -o- -ms- '.split(' ');
  var mq = function(query) {
    return window.matchMedia(query).matches;
  }

  if (('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {
    return true;
  }

  // include the 'heartz' as a way to have a non matching MQ to help terminate the join
  // https://git.io/vznFH
  var query = ['(', prefixes.join('touch-enabled),('), 'heartz', ')'].join('');
  return mq(query);
}
$('.scene-play').each(function(){
    if (is_touch_device()) {
        $(this).on('dblclick', function() {
            $(this.form).submit();
        });
    } else {
        $(this).prop("type", "submit");
    }
});

if ($.cookie("disable_drag_and_drop") != null) {
    $("#toggle-drag-and-drop").removeClass("btn-secondary");
    $("#toggle-drag-and-drop").addClass("btn-danger");
    sortable.option("disabled", true);
}
$("#toggle-drag-and-drop").on("click", function() {
    if ($.cookie("disable_drag_and_drop") == null) {
        $.cookie("disable_drag_and_drop", "1");
    } else {
        $.removeCookie("disable_drag_and_drop");
    }
    $("#toggle-drag-and-drop").toggleClass("btn-secondary");
    $("#toggle-drag-and-drop").toggleClass("btn-danger");
    sortable.option("disabled", !sortable.option("disabled"));
});

//websocket address
var socket;
if (!window.WebSocket) {
  window.WebSocket = window.MozWebSocket;
}
if (window.WebSocket) {
    socket = new WebSocket("ws://" + host + "/websocket");
    socket.onmessage = function(event) {
        console.log(event.data);
        var split = event.data.split(":");

        var element = $("." + split[0] + "-" + split[1]).parent().find("span");
        if (split[2] == "true") {
            element.addClass("text-info");
            element.removeClass("text-warning");
        } else {
            element.removeClass("text-info");
            element.addClass("text-warning");
        }
        if (split.length == 4) {
            document.getElementsByClassName(split[0] + "-" + split[1])[0].value = parseInt(split[3]);
        }

    }
    socket.onclose = function(event) {
         alertify.error("Connection closed");
    }
    socket.onopen = function(event) {
        alertify.success("Connected");
        send("register");
    }
} else {
    alert("Your browser does not support web sockets: Live update will be disabled");
}
</script>